<html>
<head>
<script src="/socket.io/socket.io.js"></script>
<link rel="stylesheet" media="screen and (max-width: 1000px)" type="text/css" href="style-m.css">
<link rel="stylesheet" media="screen and (min-device-width: 1001px)" href="style.css" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<script>

// connect to nodejs server
var urlarr = window.location.href.split("/");
var server = urlarr[0] + "//" + urlarr[2]
var socket = io.connect(server);

var registeredParticipants = []; // a list of users: [pid, guid]

// listen for messages about newly registered users
socket.on('newuser', function (data) {
    // new user with particpant id = data.pid
    if(data.session === session){
        registeredParticipants.push([data.pid, data.guid]);
    }
    loadUsers();
    newUser(data.pid, data.guid);
});

// load list of current users
socket.on('userlist', function (data){
    // do nothing if we already have participants...
    if(registeredParticipants.length > 0){
        return;
    }
    var list = data.list;
    for (var i = 0; i<list.length; i++){
        registeredParticipants.push([list[i].pid, list[i].guid]);
        newUser(list[i].pid, list[i].guid);
    }
    loadUsers();
});

socket.on('feedback', function(data){
    displayFeedback(data.user, data.message)
});

// retrieve a GET parameter
function get(name){
   if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
      return decodeURIComponent(name[1]);
}

// display a message relating to a user
function displayFeedback(guid, message){
    if(guid === 'all'){
        var allFields = document.getElementsByTagName('textarea');
        for(var i = 0; i < allFields.length; i++){
            allFields[i].value += "\n";
            allFields[i].value += message;
            allFields[i].scrollTop = allFields[i].scrollHeight;
        }
    }
    else{
        var userField = document.getElementById('feedback-'+guid);
        userField.value += "\n";
        userField.value += message;
        userField.scrollTop = userField.scrollHeight;
    }
}

// a new user has registered
function newUser(pid, guid){
    var feedbackPane = document.getElementById('feedback');
    var newUserPanel = document.createElement('div');
    newUserPanel.className = 'feedback';
    // title
    var title = document.createElement('h2');
    var tc = document.createTextNode(pid);
    title.appendChild(tc);
    newUserPanel.appendChild(title);
    // controls
    var controls = document.createElement('div');
    controls.appendChild(getNewPageButton('wheel', '/wheel', guid));
    controls.appendChild(getNewPageButton('dial', '/dial', guid));
    controls.appendChild(getNewPageButton('questions', '/questions', guid));
    newUserPanel.appendChild(controls);
    // feedback
    var panel = document.createElement('textarea');
    panel.id = 'feedback-' + guid;
    newUserPanel.appendChild(panel);
    feedbackPane.appendChild(newUserPanel);
}

function getNewPageButton(label, url, guid){
    var wheelBtn = document.createElement('button');
    wheelBtn.appendChild(document.createTextNode(label));
    wheelBtn.className = 'half';
    wheelBtn.onclick = (function() {
        // var currentI = i;
        return function() {
            // onClickLink(currentI + '');
            sendUserChangeMessage(url, guid);
            displayFeedback(guid, 'set page to ' + label);
        }
     })();
     return wheelBtn;
}

// populate the list of users using the registeredParticipants array
function loadUsers(){
    var select = document.getElementById('participantid');
    // clear
    while (select.firstChild) {
        select.removeChild(select.firstChild);
    }
    // add
    for (var i=0; i<registeredParticipants.length; i++){
        var opt = document.createElement('option');
        opt.value = registeredParticipants[i][1];
        opt.innerHTML = registeredParticipants[i][0];
        select.appendChild(opt);
    }
    // all users option:
    var opt = document.createElement('option');
    opt.value = "all";
    opt.innerHTML = "all";
    select.appendChild(opt);

}

// ask the server to broadcast a message so this user will change page to given
// url
function setUserToPage(url){
    var user = document.getElementById('participantid');
    var guid = user.value;
    sendUserChangeMessage(url, guid);
    displayFeedback(guid, 'setting to ' + url);
}


function sendUserChangeMessage(url, guid){
    socket.emit('static', {
        "url": url, "guid": guid, "session": session
    });
}

// end this session
function end(){
    socket.emit('endsession', { 'sessionid': session });
}

// send a message to server - for synchronising with media
function syncEvent(url){
    var label = document.getElementById('eventLabel');
    socket.emit('log', { 'event': label.value, 'session': session });
    displayFeedback('all', 'event: ' + label.value);
}

// get s=? from url
var session;
session = get('s');
if (session == null){
    // if not
    var session = prompt("Please enter a session name");
    socket.emit('newsession', { 'sessionid': session });
}
else{
    // load controls for all users:
    socket.emit('getusers', {'session': session });
}
document.title = "Control panel for " + session + " session";

</script>
</head>

<body>

<h2>Wheel/dial selector</h2>
<div>
    <select id='participantid'>
        <!-- options added dynamically as they register -->
    </select>
<div>
    <button class='half' onclick="setUserToPage('/wheel')">Wheel</button>
    <button class='half' onclick="setUserToPage('/dial')">Dial</button>
    <button class='half' onclick="setUserToPage('/questions')">Questions</button>
</div>
</div>

<hr>
<h2>Log event:</h2>
<div>
    <input type='text' id='eventLabel' />
    <button onclick="syncEvent()">Go</button>
</div>

<hr>
<h2>End session:</h2>
<div>
    <button onclick="end()">End session</button>
</div>

<!-- div class='feedback'>
    <h3>All results</h3>
    <textarea id='logPanel'></textarea>
</div -->

<hr>
<div id='feedback'>
    <h2>Participant data:</h2>
</div>

</body>
