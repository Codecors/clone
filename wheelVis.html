<!DOCTYPE html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
	<div width='100%'>
        <object id='wheel-svg' width='100%' type='image/svg+xml' data='./customGEW.svg'></object>
	</div>
<script>

    // the letters
    var letters = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i',	'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't'];

    // the labels, as map to letters above
    var labels = ['shock', 'interest', 'anger', 'hate', 'amusement',
    	'pride', 'joy', 'contentment', 'contempt', 'disgust', 'fear',
    	'confusion', 'disappointment', 'relief', 'admiration', 'love',
    	'guilt', 'regret', 'compassion', 'sadness'];

    // retrieve a GET parameter
    function get(name){
       if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
          return decodeURIComponent(name[1]);
    }


    //  initiate results
    var results = {};
    for(var i = 0; i < letters.length; i++){
		for(var j = 1; j <= 4; j++){
			var circle_id = "circle" + j + "-" + letters[i];
			results[circle_id] = 0;
		}
	}
    var max = 0;


    // new set of results in
    function logResults(selection){
        for(var i = 0; i < selection.length; i++){
            var circle = selection[i];
            if(results[circle] == null){
                results[circle] = 0;
            }
            else{
                results[circle] += 1;
                if(results[circle] > max){ max = results[circle]; }
            }
            animate(circle);
        }
        setOpacities();

    }


    // animate a circle to show it has been clicked
    function animate(circle){
        var svg = document.getElementById("wheel-svg");
    	svgDoc = svg.contentDocument;
        var c = svgDoc.getElementById(circle);
        var currentRadius = c.getAttribute('r');
        var currentStroke = c.style.strokeWidth;
        // var currentStyle = c.getAttribute('style');

        c.setAttribute('r', currentRadius * 1.3);
        c.style.strokeWidth = '5';
        window.setTimeout(function () {
            c.setAttribute('r', currentRadius);
            c.style.strokeWidth = currentStroke;
            // c.setAttribute('style', currentStyle);
         }, 1000);

    }


     function setOpacities(){
         var svg = document.getElementById("wheel-svg");
         svgDoc = svg.contentDocument;
         for(k in results){
             var opacity = results[k]/max;
             var c = svgDoc.getElementById(k);
             c.style.opacity = opacity;
         }
     }

    // nodejs initiation
    var urlarr = window.location.href.split("/");
    var server = urlarr[0] + "//" + urlarr[2]
    var socket = io.connect(server);
    console.log('connected');
    var nodejs = true;
    var session = get('s');
    var pid = get('p');
    socket.emit('joinSession', {"session": session });

    socket.on('wheelUpdate', function(data){
        if(data.pid === pid || pid == null){
            logResults(data.value);
        }
    });


</script>
</body>
</html>
