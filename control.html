<html>
<head>
<script src="/socket.io/socket.io.js"></script>
<script>

// connect to nodejs server
var urlarr = window.location.href.split("/");
var server = urlarr[0] + "//" + urlarr[2]
var socket = io.connect(server);

var registeredParticipants = []; // a list of users: [pid, guid]

// listen for messages about newly registered users
socket.on('newuser', function (data) {
    // new user with particpant id = data.pid
    if(data.session === session){
        registeredParticipants.push([data.pid, data.guid]);
    }
    loadUsers();
});

socket.on('log', function(data){
    // console.log(data.message);
    var logger = document.getElementById('logPanel');
    logger.value += data.message;
    // and display...
});

// populate the list of users using the registeredParticipants array
function loadUsers(){
    var select = document.getElementById('participantid');
    // clear
    while (select.firstChild) {
        select.removeChild(select.firstChild);
    }
    // add
    for (var i=0; i<registeredParticipants.length; i++){
        var opt = document.createElement('option');
        opt.value = registeredParticipants[i][1];
        opt.innerHTML = registeredParticipants[i][0];
        select.appendChild(opt);
    }
    // all users option:
    var opt = document.createElement('option');
    opt.value = "all";
    opt.innerHTML = "all";
    select.appendChild(opt);

}

// ask the server to broadcast a message so this user will change page to given
// url
function setUserToPage(url){
    var user = document.getElementById('participantid');
    var guid = user.value;

    socket.emit('static', {
        "url": url, "guid": guid, "session": session
    });
}

// end this session
function end(){
    socket.emit('endsession', { 'sessionid': session });
}

// send a message to server - for synchronising with media
function syncEvent(url){
    var label = document.getElementById('eventLabel');
    socket.emit('log', { 'event': label.value, 'session': session });
}

var session = prompt("Please enter a session name");
document.title = "Control panel for " + session + " session";
socket.emit('newsession', { 'sessionid': session });

</script>
</head>

<body>

<h2>Wheel/dial selector</h2>
<hr>
<p>Participant:
    <select id='participantid'>
        <!-- options added dynamically as they register -->
    </select>
    <button onclick="setUserToPage('/wheel')">Wheel</button>
    <button onclick="setUserToPage('/dial')">Dial</button>
</p>

<p>Log event:
    <input type='text' id='eventLabel' />
    <button onclick="syncEvent()">Go</button>
</p>

<p>End session:
    <button onclick="end()">End</button>
</p>

<p>
    <textarea id='logPanel' ></textarea>
</p>

</body>
